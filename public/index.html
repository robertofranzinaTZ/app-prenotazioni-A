<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Prenotazioni</title>
<style>
  table { border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #000; padding: 5px; text-align: center; }
  button { margin: 2px; }
  select { display: none; margin-top: 5px; }
</style>
</head>
<body>
<h1>Prenotazioni</h1>
<table id="slots-table">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
async function loadSlots() {
  const res = await fetch("/api/slots");
  const data = await res.json();

  const thead = document.querySelector("#slots-table thead");
  const tbody = document.querySelector("#slots-table tbody");
  thead.innerHTML = "<tr><th>Ora</th>" + data.headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  data.slots.forEach((slot, oraIndex) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${slot.ora}</td>` +
      slot.posti.map((p, giornoIndex) =>
        `<td>
          <button data-ora="${oraIndex}" data-giorno="${giornoIndex}" ${p<=0?'disabled':''}>
            ${p} posti
          </button>
          <select></select>
        </td>`).join("");
    tbody.appendChild(tr);
  });

  // Carica nomi
  const namesRes = await fetch("/api/names");
  const names = await namesRes.json();

  // Aggiungi eventi ai pulsanti
  document.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const cell = btn.parentElement;
      const select = cell.querySelector("select");
      select.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");
      select.style.display = "block";

      select.onchange = async () => {
        const nome = select.value;
        const oraIndex = parseInt(btn.dataset.ora);
        const giornoIndex = parseInt(btn.dataset.giorno);
        const res = await fetch("/api/book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ giornoIndex, oraIndex, nome })
        });
        if (res.ok) {
          const result = await res.json();
          alert(`Prenotazione confermata per ${nome}`);
          btn.textContent = result.postiRimasti + " posti";
          if (result.postiRimasti <= 0) btn.disabled = true;
          select.style.display = "none";
        } else {
          const text = await res.text();
          alert("Errore: " + text);
        }
      };
    });
  });
}

loadSlots();
</script>
</body>
</html>
